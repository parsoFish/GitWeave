services:
  api:
    image: node:22-bookworm-slim
    user: root
    working_dir: /workspace
    environment:
      NODE_ENV: development
      PORT: 8080
      COOKIE_SECURE: '0'
      # Store repos under a dedicated volume path inside the container
      REPOS_ROOT: /data/repos
    command: sh -c "apt-get update && apt-get install -y git && npm --prefix app ci && npm --prefix app run dev"
    # Do not publish API port to host; UI proxies internally to avoid host port conflicts
    volumes:
      - ./:/workspace
      - ./app/data/repos:/data/repos

  ui:
    image: node:22-alpine
    working_dir: /workspace
    environment:
      NODE_ENV: development
      # Point Vite proxy at the API service name inside Compose
      VITE_API_PROXY_TARGET: http://api:8080
    command: sh -c "npm --prefix ui ci && npm --prefix ui run dev -- --host"
    ports:
      - "5173:5173"
    depends_on:
      - api
    volumes:
      - ./:/workspace

